# .github/workflows/library_ci.yml

name: CozyTracker Library CI/CD

on:
  # Run on every push to the main branch
  push:
    branches:
      - main
  # Run when a new version tag is pushed (e.g., v1.0.0)
  tags:
    - 'v*.*.*'
  # Allow manual runs from the GitHub Actions tab
  workflow_dispatch:

jobs:
  # --- JOB 1: Build & Test on Every Push ---
  build-and-test:
    name: Build & Test Library
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Gradle Cache
        uses: gradle/gradle-build-action@v2

      - name: Build and Run Unit Tests for the Library
        # This command targets ONLY the :cozy_tracker module
        run: ./gradlew :cozy_tracker:testReleaseUnitTest

      - name: Run Lint Checks on the Library
        run: ./gradlew :cozy_tracker:lintRelease

  # --- JOB 2: Publish on New Version Tag ---
  publish-release:
    name: Publish Library Release
    # This job only runs if a version tag was pushed
    if: startsWith(github.ref, 'refs/tags/')
    # It requires the build-and-test job to succeed first
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Setup Gradle Cache
        uses: gradle/gradle-build-action@v2

      - name: Get Version Name from Tag
        # Extracts the version number from the tag (e.g., v1.0.2 -> 1.0.2)
        run: echo "RELEASE_VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Publish Library to Maven Central
        # This command targets ONLY the :cozy_tracker module's publishing task
        # It passes the version number and secrets from GitHub to Gradle
        run: ./gradlew :cozy_tracker:publishReleasePublicationToSonatypeRepository --max-workers 1
        env:
          # These secrets must be configured in your GitHub repository settings
          # (Settings -> Secrets and variables -> Actions)
          OSSRH_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          OSSRH_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          # This passes the version number from the tag to your build script
          RELEASE_VERSION: ${{ env.RELEASE_VERSION }}
